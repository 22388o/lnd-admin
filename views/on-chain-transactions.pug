extends layout4

block breadcrumb
	li.breadcrumb-item
		a(href='/') Home
	li.breadcrumb-item Payments
	li.breadcrumb-item My Wallet Transactions

block content
	if (false)
		pre
			code.json.bg-light #{JSON.stringify(localChannels, null, 4)}

		pre
			code.json.bg-light #{JSON.stringify(localClosedChannels, null, 4)}

	if (!session.admin)
		h1.h3 My Wallet Transactions
		hr

		- var loginRequiredNote = "display details about this node's on-chain wallet transactions.";
		include includes/login-required-alert.pug

	else

		- var unconfirmedTxCount = 0;
		each tx, index in onChainTransactions.transactions
			if (tx.num_confirmations == 0)
				- unconfirmedTxCount++;

		- var confirmedTxCount = (onChainTransactions.transactions.length - unconfirmedTxCount);



		if (unconfirmedTxCount > 0)
			div(class="mb-4")
				h1.h3 #{unconfirmedTxCount.toLocaleString()} 
					if (unconfirmedTxCount == 1)
						span Unconfirmed Transaction
					else
						span Unconfirmed Transactions

				hr

				div(class="table-responsive")
					table(class="table table-bordered border-top")
						thead.bg-light
							tr
								th #
								th Txid
								th Amount
						
						tbody.text-monospace
							each tx, index in onChainTransactions.transactions
								if (tx.num_confirmations == 0)
									tr
										td.font-weight-bold #{(index + 1).toLocaleString()}
										td(class="table-col-text")
											if (config.blockExplorerUrl)
												a(href=(config.blockExplorerUrl + "/tx/" + tx.tx_hash), title=tx.tx_hash, data-toggle="tooltip") #{tx.tx_hash.substring(0, config.site.txidMaxDisplayLength)}
											else
												span(title=tx.tx_hash, data-toggle="tooltip") #{tx.tx_hash.substring(0, config.site.txidMaxDisplayLength)}

										td(class="table-col-currencyvalue")
											- var currencyValue = new Decimal(Math.abs(parseInt(tx.amount))).dividedBy(coinConfig.baseCurrencyUnit.multiplier);
											if (parseInt(tx.amount) > 0)
												div(class="text-success")
													span +
													include ./includes/value-display.pug
											else
												div(class="text-danger")
													span -
													include ./includes/value-display.pug

		div(class="mb-4")
			h1.h3 #{confirmedTxCount.toLocaleString()} 
				if (unconfirmedTxCount > 0)
					span Confirmed 

				if (unconfirmedTxCount == 1)
					span Transaction
				else
					span Transactions

			hr

			div(class="table-responsive")
				table(class="table table-bordered border-top")
					thead.bg-light
						tr
							th.text-right #
							th Txid
							th Addresses
							th
								span.border-dotted(title="If applicable, show the channel opened with the transaction.", data-toggle="tooltip") Channel Opened
							th.text-right
								span Block /
								br
								span Confirmations
							th Date
							th.text-right Amount
					
					tbody.text-monospace
						- onChainTransactions.transactions.reverse();
						each tx, index in onChainTransactions.transactions
							if (tx.num_confirmations > 0)
								tr
									td.text-right.font-weight-bold #{(index + 1).toLocaleString()}
									td(class="table-col-text")
										if (config.blockExplorerUrl)
											a(href=(config.blockExplorerUrl + "/tx/" + tx.tx_hash), target="_blank", title=tx.tx_hash, data-toggle="tooltip") #{tx.tx_hash.substring(0, config.site.txidMaxDisplayLength)}
										else
											span(title=tx.tx_hash, data-toggle="tooltip") #{tx.tx_hash.substring(0, config.site.txidMaxDisplayLength)}

									td(class="table-col-text")
										if (config.blockExplorerUrl)
											each addr, index in tx.dest_addresses
												a(href=(config.blockExplorerUrl + "/address/" + addr), target="_blank", title=addr, data-toggle="tooltip") #{addr.substring(0, config.site.addressMaxDisplayLength)}
												br
										else
											each addr, index in tx.dest_addresses
												span(title=addr, data-toggle="tooltip") #{addr.substring(0, config.site.addressMaxDisplayLength)}
												br

									td
										if (localChannels.byTxid[tx.tx_hash] != null)
											a(href=`/channel/${localChannels.byTxid[tx.tx_hash].chan_id}`)
												- var channel_id = localChannels.byTxid[tx.tx_hash].chan_id;
												include includes/channel-id.pug

										else if (closedChannels.byTxid[tx.tx_hash] != null)
											span #{closedChannels.byTxid[tx.tx_hash].chan_id}
											br
											span.text-muted (closed)

										else
											span -

									td(class="table-col-int text-right")
										if (config.blockExplorerUrl)
											a(href=(config.blockExplorerUrl + "/block-height/" + tx.block_height), target="_blank") #{parseInt(tx.block_height).toLocaleString()}
										else
											span(title=tx.tx_hash, data-toggle="tooltip") #{parseInt(tx.block_height).toLocaleString()}

										br
										span #{tx.num_confirmations.toLocaleString()}

									td(class="table-col-time")
										- var timeAgo = moment.duration(moment.utc(new Date()).diff(moment.utc(new Date(parseInt(tx.time_stamp) * 1000))));
										- var dateTimeUtc = moment.utc(new Date(parseInt(tx.time_stamp) * 1000)).format("Y-MM-DD HH:mm:ss");

										span #{dateTimeUtc} utc
										br
										span.text-muted #{timeAgo.humanize()} ago

									td(class="table-col-currencyvalue text-right")
										- var currencyValue = new Decimal(Math.abs(parseInt(tx.amount))).dividedBy(coinConfig.baseCurrencyUnit.multiplier);
										if (parseInt(tx.amount) > 0)
											div(class="text-success")
												span +
												include ./includes/value-display.pug
										else if (parseInt(tx.amount) < 0)
											div(class="text-danger")
												span -
												include ./includes/value-display.pug
										else
											span -

